# Video Traffic Load Balancer

Балансировщик видео трафика.
- Веб фреймворк: FastApi
- БД и ORM: postgres + async sqlalchemy
- Миграции БД: alembic
- Кеширование: Redis
- Контейнеризация: Docker

### Установка и запуск

1. Склонируйте репозиторий:
    ```bash
    git clone [url репозитория]
    ```

2. Запустите сервис с помощью Docker Compose:
    ```bash
    docker-compose up --build
    ```
В проекте есть скрипт применения миграций, поэтому вручную ничего делать не нужно.
Хост CDN хранится в БД

## Сервис будет доступен по адресу:
```
http://localhost:8000/
```
## Swagger документация:
```
http://localhost:8000/docs
```
```
http://localhost:8000/redoc
```

### API

#### 1. Редирект видео

- Редирект:
    ```
    GET / Параметр: video (URL видео)
    ```


#### 2. Конфигурация

- Получить конфигурацию:
    ```
    GET /config
    ```

- Создать конфигурацию:
    ```
    POST /config
    ```

- Обновить конфигурацию:
    ```
    PUT /config
    Параметры: cdn_host (string), ratio (integer)
    ```

# Как можно доработать и улучшить сервис?

## 1. Масштабируемость и производительность
- **Добавить Redis** для кеширования частых запросов и снижения нагрузки на PostgreSQL
- **Ввести rate-limiting** (например, через `fastapi-limiter`), чтобы защититься от DDoS
- **Оптимизировать работу с БД** (пул соединений, индексы, репликация)

## 2. Отказоустойчивость
- **Health-check эндпоинты** (`/health`), чтобы мониторить состояние сервиса
- **Ретри-логика** при ошибках подключения к БД или CDN
- **Graceful shutdown** для корректной обработки остановки контейнера

## 3. Безопасность
- **Валидация входных URL** (проверка доменов, защита от SSRF)
- **JWT-аутентификация** для API, если нужно администрирование
- **HTTPS** (можно добавить через Traefik/Nginx в `docker-compose`)

## 4. Мониторинг и логирование
- **Prometheus + Grafana** для метрик (количество запросов, время ответа)
- **Structured logging** (JSON-логи через `loguru` или `structlog`)
- **Sentry** для отслеживания ошибок

## 5. Улучшение алгоритма балансировки
- **Весовая балансировка** (не просто "каждый N-й запрос", а с учетом нагрузки)
- **Гео-балансировка** (если CDN имеет разные точки присутствия)
- **Фолбэк на origin**, если CDN недоступен

## 6. API для управления конфигурацией
- **Валидация новых настроек** перед применением
- **Версионирование конфигов** (чтобы можно было откатиться)

## 7. Тестирование
- **Unit-тесты** (например, `pytest` с `asyncio`)
- **Интеграционные тесты** (тестовый PostgreSQL + Redis)
- **Load-тесты** (через `locust` или `k6`)
